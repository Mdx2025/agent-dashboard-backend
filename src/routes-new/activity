import express from 'express';

const router = express.Router();

// GET /api/activity - Feed de actividad
router.get('/', async (req, res) => {
  try {
    const { Activity } = req.app.get('models');
    const { agentId, type, limit = 50, offset = 0 } = req.query;
    
    const where = {};
    if (agentId) where.agentId = agentId;
    if (type) where.type = type;

    const activities = await Activity.findAll({
      where,
      order: [['timestamp', 'DESC']],
      limit: parseInt(limit),
      offset: parseInt(offset)
    });

    res.json(activities);
  } catch (error) {
    console.error('Get activities error:', error);
    res.status(500).json({ error: 'Failed to fetch activities' });
  }
});

// POST /api/activity - Crear actividad
router.post('/', async (req, res) => {
  try {
    const { Activity } = req.app.get('models');
    const { agentId, type, action, details } = req.body;
    
    if (!action) {
      return res.status(400).json({ error: 'Action is required' });
    }

    const activity = await Activity.create({
      agentId,
      type: type || 'system',
      action,
      details: details || {},
      timestamp: new Date()
    });

    // Emit WebSocket event
    const io = req.app.get('io');
    io.emit('activity.new', activity);

    res.status(201).json(activity);
  } catch (error) {
    console.error('Create activity error:', error);
    res.status(500).json({ error: 'Failed to create activity' });
  }
});

// GET /api/activity/recent - Actividad reciente
router.get('/recent', async (req, res) => {
  try {
    const { Activity } = req.app.get('models');
    const { hours = 24, limit = 20 } = req.query;
    
    const since = new Date(Date.now() - (parseInt(hours) * 60 * 60 * 1000));
    
    const activities = await Activity.findAll({
      where: {
        timestamp: { [Activity.sequelize.Op.gte]: since }
      },
      order: [['timestamp', 'DESC']],
      limit: parseInt(limit)
    });

    res.json(activities);
  } catch (error) {
    console.error('Get recent activities error:', error);
    res.status(500).json({ error: 'Failed to fetch recent activities' });
  }
});

export default router;
