// backend/app/src/prisma/schema.prisma

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl"]
}

// -------------------------------------------------
// Data Models from Technical Documentation
// -------------------------------------------------

model Agent {
  id            String      @id @default(cuid())
  name          String
  type          AgentType   @default(MAIN)
  status        AgentStatus @default(idle)
  model         String
  provider      String
  description   String?
  runs24h       Int         @default(0)
  runsAll       Int         @default(0)
  err24h        Int         @default(0)
  tokensIn24h   Int         @default(0)
  tokensOut24h  Int         @default(0)
  costDay       Float       @default(0)
  costAll       Float       @default(0)
  latencyAvg    Float       @default(0)
  latencyP95    Float       @default(0)
  contextAvgPct Float       @default(0)
  tools         String[]
  maxTokens     Int?
  temperature   Float?
  uptime        Float       @default(100)
  errors        Json[] // Array of AgentError JSON objects
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  tokenUsages TokenUsageRow[]
}

enum AgentType {
  MAIN
  SUBAGENT
}

enum AgentStatus {
  active
  idle
  error
  offline
}

model Session {
  id         String        @id @default(cuid())
  status     SessionStatus @default(active)
  startedAt  DateTime      @default(now())
  lastSeenAt DateTime      @updatedAt
  tokens24h  Int           @default(0)
  model      String
  agentName  String // "agent" is a reserved keyword

  tokenUsages TokenUsageRow[]
}

enum SessionStatus {
  active
  idle
  closed
}

model Run {
  id           String        @id @default(cuid())
  source       RunSource     @default(MAIN)
  label        String
  status       RunStatus     @default(queued)
  startedAt    DateTime      @default(now())
  duration     Int? // ms
  model        String
  contextPct   Float         @default(0)
  tokensIn     Int           @default(0)
  tokensOut    Int           @default(0)
  finishReason FinishReason?

  logs LogEntry[]
}

enum RunSource {
  MAIN
  SUBAGENT
  CRON
}

enum RunStatus {
  queued
  running
  finished
  failed
}

enum FinishReason {
  stop
  tool_calls
  error
  length
}

model TokenUsageRow {
  id           String       @id @default(cuid())
  timestamp    DateTime     @default(now())
  provider     String
  model        String
  agent        Agent        @relation(fields: [agentId], references: [id])
  agentId      String
  tokensIn     Int
  tokensOut    Int
  cost         Float
  speed        Float // tokens/sec
  finishReason FinishReason
  session      Session      @relation(fields: [sessionId], references: [id])
  sessionId    String
}

model Skill {
  id           String      @id @default(cuid())
  name         String      @unique
  version      String
  category     String
  enabled      Boolean     @default(true)
  status       SkillStatus @default(ok)
  description  String
  usage24h     Int         @default(0)
  latencyAvg   Float       @default(0)
  latencyP95   Float       @default(0)
  errorRate    Float       @default(0)
  config       Json // Store config as a JSON object
  dependencies String[]
  changelog    Json[] // Store changelog as an array of JSON objects
}

enum SkillStatus {
  ok
  warn
  error
}

model HealthCheck {
  id         String       @id @default(cuid())
  name       String
  status     HealthStatus @default(pass)
  detail     String
  durationMs Int
  createdAt  DateTime     @default(now())
}

enum HealthStatus {
  pass
  warn
  fail
}

model Service {
  id        String        @id @default(cuid())
  name      String        @unique
  status    ServiceStatus @default(healthy)
  host      String?
  port      Int?
  latencyMs Int           @default(0)
  cpuPct    Float         @default(0)
  memPct    Float         @default(0)
  version   String?
  metadata  Json          @default("{}")
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

enum ServiceStatus {
  healthy
  degraded
  offline
}

model LogEntry {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())
  level     LogLevel
  source    String
  message   String
  run       Run?     @relation(fields: [runId], references: [id])
  runId     String?
  requestId String?
  extra     Json?
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  FATAL
}
